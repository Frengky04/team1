<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Confirmation | Dialogika</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .disabled-input { background-color: #f1f5f9; cursor: not-allowed; color: #94a3b8; }
        .upload-area:hover { border-color: #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-900 antialiased">

    <!-- HEADER CONTEXT -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-10 shadow-sm">
        <div class="max-w-xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-extrabold tracking-tight" id="leadName">Andi Pratama</h1>
                    <p class="text-sm text-slate-500 font-medium">Konfirmasi Pembayaran Anda</p>
                    <p class="mt-1 text-[11px] font-mono text-slate-400">
                        Invoice <span id="invoiceNumber" class="font-semibold text-slate-600"></span>
                    </p>
                </div>
                <div class="flex items-center">
                    <img src="https://www.dialogika.co/assets/img/logo.webp" alt="Dialogika" class="h-9 w-auto">
                </div>
            </div>
            
            <div class="mt-4 p-4 bg-slate-900 rounded-2xl text-white">
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Kelas Yang Diambil</p>
                <div class="flex justify-between items-end mt-1">
                    <div>
                        <h2 class="font-bold text-lg" id="className">Public Speaking Playbook</h2>
                        <p id="classMeta" class="text-xs text-slate-400 italic">Batch 42 • Offline • Jakarta</p>
                        <div class="mt-1">
                            <span id="seatLeftLabel" class="inline-flex items-center px-2 py-1 rounded-full text-[10px] font-black bg-emerald-500/10 text-emerald-500 uppercase tracking-widest">
                                Sisa Seat : 4
                            </span>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-[10px] block opacity-60 uppercase font-bold">Total Harga</span>
                        <span class="text-lg font-black text-green-400" id="displayBasePrice">Rp 2.500.000</span>
                    </div>
                </div>
            </div>

            <div class="mt-3 p-3 bg-red-500 rounded-2xl text-white flex items-center justify-between">
                <div>
                    <p class="text-[10px] text-white-300 font-bold uppercase tracking-widest">Batas Waktu Pembayaran</p>
                    <p class="text-[11px] text-white-400 font-medium">Selesaikan pembayaran sebelum waktu habis.</p>
                </div>
                <div class="text-right">
                    <span id="countdownTimer" class="font-mono text-xl font-black">00:00</span>
                </div>
            </div>
        </div>
        
    </header>

    <main class="max-w-xl mx-auto px-6 mt-8 pb-20">
        
        <!-- MAIN FORM CARD -->
        <div class="bg-white rounded-[2rem] shadow-xl shadow-slate-200/50 border border-slate-200 overflow-hidden">
            <div class="p-8 space-y-6">
                
                <!-- 1. PRICE (READ ONLY) -->
                <div>
                    <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 tracking-widest">Harga Kelas</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold font-mono text-lg">Rp</span>
                        <input type="text" id="inputPrice" value="2.500.000" readonly 
                            class="w-full pl-12 pr-4 py-4 disabled-input border-2 border-slate-100 rounded-2xl text-xl font-black outline-none">
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 tracking-widest">Kode Referral (Chat Admin)</label>
                    <div class="relative">
                        <input type="text" id="referralCode" class="w-full p-4 pr-24 bg-slate-50 border-2 border-slate-100 rounded-2xl text-sm font-medium outline-none focus:border-blue-500 transition-all" placeholder="Masukkan kode referral jika ada">
                        <button type="button" onclick="checkReferral()" class="absolute right-2 top-1/2 -translate-y-1/2 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs font-black rounded-xl uppercase tracking-widest">Check</button>
                    </div>
                    <p id="referralMessage" class="hidden text-[10px] font-bold mt-1 uppercase tracking-tight"></p>
                </div>

                <!-- 2. PAYMENT TYPE -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 tracking-widest">Tipe Pembayaran</label>
                        <select id="paymentType" onchange="handlePaymentTypeChange()" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-black text-lg outline-none focus:border-blue-500 transition-all">
                            <option value="full">Lunas (Full Payment)</option>
                            <option value="dp">DP (Down Payment)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 tracking-widest">Nominal Bayar</label>
                        <input type="text" id="amountPaid" value="2500000" readonly
                            oninput="handleAmountInputChange()"
                            class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-black text-lg outline-none focus:border-blue-500 transition-all">
                        <p id="minWarning" class="hidden text-[10px] text-red-500 font-bold mt-1 uppercase tracking-tight italic">* Minimal DP 35% (Rp 875.000)</p>
                    </div>
                </div>

                <!-- 3. METHOD SELECT -->
                <div>
                    <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 tracking-widest">Metode Pembayaran</label>
                    <div class="space-y-3">
                        <select id="paymentMethod" onchange="handleMethodChange()" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-bold text-sm outline-none focus:border-blue-500 transition-all">
                            <option value="Transfer Bank">Transfer Bank</option>
                            <option value="Cash">Cash (Tunai)</option>
                            <option value="QRIS" disabled>QRIS (Coming Soon)</option>
                        </select>
                    </div>
                </div>

                <!-- 4. CONDITIONAL SECTION: TRANSFER BANK -->
                <div id="sectionTransfer" class="space-y-4 animate-in fade-in slide-in-from-top-4 duration-300">
                    <div>
                        <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 tracking-widest">Pilih Bank</label>
                        <select id="bankOption" onchange="handleBankChange()" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-bold text-sm outline-none focus:border-blue-500 transition-all">
                            <option value="BCA">BCA</option>
                            <option value="BCA Syariah">BCA Syariah</option>
                            <option value="BSI">BSI</option>
                            <option value="BRI">BRI</option>
                            <option value="SMBC">SMBC</option>
                        </select>
                    </div>

                    <div class="p-4 bg-blue-50 rounded-2xl border border-blue-100">
                        <p class="text-[11px] font-black text-blue-600 uppercase tracking-widest mb-2">Rekening Tujuan</p>
                        <div class="flex justify-between items-center">
                            <div>
                                <span id="displayBankInfo" class="font-black text-slate-700 block">BCA - 8920129301</span>
                                <span id="displayAccountHolder" class="text-xs text-slate-500 font-semibold">a.n. PT Dialogika Indonesia</span>
                            </div>
                            <span id="copyRekeningBtn" onclick="copyRekening()" class="text-[10px] bg-white px-2 py-1 rounded border border-blue-200 text-blue-600 font-bold cursor-pointer select-none">Copy</span>
                        </div>
                        
                    </div>

                    <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 tracking-widest">Upload Bukti Transfer</label>
                    <div class="upload-area relative border-2 border-dashed border-slate-200 rounded-2xl p-8 transition-all group">
                        <input type="file" id="fileUpload" accept="image/*,.pdf" onchange="handleFileUpload()" 
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        <div class="text-center">
                            <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                                <i data-lucide="upload-cloud" class="text-blue-600 w-6 h-6"></i>
                            </div>
                            <p class="text-sm font-bold text-slate-700">Klik atau seret file ke sini</p>
                            <p class="text-[10px] text-slate-400 mt-1 font-medium">PNG, JPG, atau PDF (Maks. 5MB)</p>
                        </div>
                    </div>
                    <!-- Success Upload Message -->
                    <div id="uploadSuccess" class="hidden flex items-center gap-2 p-3 bg-green-50 rounded-xl border border-green-100 animate-pulse">
                        <i data-lucide="check-circle-2" class="text-green-600 w-5 h-5"></i>
                        <p class="text-xs font-bold text-green-700 uppercase italic tracking-tight">Berhasil diupload! Segera pencet tombol di bawah untuk konfirmasi ke admin.</p>
                    </div>

                    
                </div>

                <!-- 5. CONDITIONAL SECTION: CASH -->
                <div id="sectionCash" class="hidden space-y-4 animate-in fade-in slide-in-from-top-4 duration-300">
                    <div class="p-6 bg-amber-50 rounded-2xl border border-amber-100 text-center">
                        <i data-lucide="map-pin" class="text-amber-600 w-10 h-10 mx-auto mb-3"></i>
                        <h4 class="font-black text-amber-800 text-sm uppercase tracking-wide">Pembayaran Tunai</h4>
                        <p class="text-xs text-amber-700 mt-2 leading-relaxed">Silahkan janjian untuk bertemu **Admin Marketing Dialogika** di kantor pusat atau lokasi kelas yang telah disepakati.</p>
                    </div>
                </div>

                <!-- PRIMARY BUTTON -->
                <div class="pt-4">
                    <button id="mainBtn" onclick="submitDeal()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-5 rounded-[1.5rem] text-lg shadow-xl shadow-blue-200 active:scale-[0.98] transition-all flex items-center justify-center gap-3">
                        <span id="btnText">CONFIRM DEAL NOW</span>
                        <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                    <p class="text-center text-[10px] text-slate-400 mt-4 font-bold uppercase tracking-widest">Contact Admin Marketing Dialogika untuk Konfirmasi Pembayaran.</p>
                </div>

            </div>
        </div>
    </main>

    <script>
        // Initialize Lucide Icons
        lucide.createIcons();

        const STORAGE_KEY_SETTINGS = "dlg_invoice_settings";
        const STORAGE_KEY_BANKS = "dlg_invoice_banks";
        const STORAGE_KEY_REFERRALS = "dlg_invoice_referrals";

        function loadInvoiceSettings() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY_SETTINGS);
                if (!raw) {
                    return {
                        leadName: "Andi Pratama",
                        className: "Public Speaking Playbook",
                        classMeta: "Batch 42 • Offline • Jakarta",
                        seatsLeft: 4,
                        deadlineMinutes: 30,
                        basePrice: 2500000,
                        dpPercent: 35
                    };
                }
                const parsed = JSON.parse(raw);
                return Object.assign({
                    leadName: "Andi Pratama",
                    className: "Public Speaking Playbook",
                    classMeta: "Batch 42 • Offline • Jakarta",
                    seatsLeft: 4,
                    deadlineMinutes: 30,
                    basePrice: 2500000,
                    dpPercent: 35
                }, parsed);
            } catch (e) {
                return {
                    leadName: "Andi Pratama",
                    className: "Public Speaking Playbook",
                    classMeta: "Batch 42 • Offline • Jakarta",
                    seatsLeft: 4,
                    deadlineMinutes: 30,
                    basePrice: 2500000,
                    dpPercent: 35
                };
            }
        }

        function loadBanksForInvoice() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY_BANKS);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                if (!Array.isArray(parsed) || !parsed.length) return null;
                const map = {};
                parsed.forEach(function (b) {
                    if (!b || !b.name) return;
                    map[b.name] = { number: b.number || "", holder: b.holder || "" };
                });
                return map;
            } catch (e) {
                return null;
            }
        }

        function loadReferralsForInvoice() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY_REFERRALS);
                const parsed = raw ? JSON.parse(raw) : [];
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                return [];
            }
        }

        const invoiceSettings = loadInvoiceSettings();
        let basePrice = invoiceSettings.basePrice || 2500000;
        let dpPercent = invoiceSettings.dpPercent || 35;
        let minDP = Math.round(basePrice * dpPercent / 100);

        function generateInvoiceNumber() {
            const now = new Date();
            const yy = String(now.getFullYear()).slice(-2);
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 9000) + 1000;
            return `INV-${yy}${mm}${dd}-${random}`;
        }

        const loadedBankMap = loadBanksForInvoice();
        const bankConfig = loadedBankMap || {
            "BCA": { number: "8920129301", holder: "PT Dialogika Indonesia" },
            "BCA Syariah": { number: "8920129301", holder: "PT Dialogika Indonesia" },
            "BSI": { number: "8920129301", holder: "PT Dialogika Indonesia" },
            "BRI": { number: "8920129301", holder: "PT Dialogika Indonesia" },
            "SMBC": { number: "8920129301", holder: "PT Dialogika Indonesia" }
        };

        const referralConfig = loadReferralsForInvoice();

        let countdownInterval = null;
        let countdownSeconds = 0;

        function formatNumberWithDots(value) {
            const numeric = value.toString().replace(/\D/g, '');
            if (!numeric) return '';
            return numeric.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function parseFormattedNumber(value) {
            const numeric = value.toString().replace(/\D/g, '');
            return numeric ? parseInt(numeric, 10) : 0;
        }

        function handleAmountInputChange() {
            const input = document.getElementById('amountPaid');
            if (!input) return;
            const numeric = parseFormattedNumber(input.value);
            input.value = numeric ? formatNumberWithDots(numeric) : '';
        }

        // Logic 1: Payment Type Changes
        function handlePaymentTypeChange() {
            const type = document.getElementById('paymentType').value;
            const amountInput = document.getElementById('amountPaid');
            const minWarning = document.getElementById('minWarning');

            if(type === 'full') {
                amountInput.value = formatNumberWithDots(basePrice);
                amountInput.readOnly = true;
                amountInput.classList.add('disabled-input');
                minWarning.classList.add('hidden');
            } else {
                amountInput.value = formatNumberWithDots(minDP);
                amountInput.readOnly = false;
                amountInput.classList.remove('disabled-input');
                minWarning.classList.remove('hidden');
                amountInput.focus();
            }
        }

        // Logic 2: Payment Method Changes
        function handleMethodChange() {
            const method = document.getElementById('paymentMethod').value;
            const sectionTransfer = document.getElementById('sectionTransfer');
            const sectionCash = document.getElementById('sectionCash');
            const mainBtn = document.getElementById('mainBtn');
            const btnText = document.getElementById('btnText');

            if(method === 'Transfer Bank') {
                sectionTransfer.classList.remove('hidden');
                sectionCash.classList.add('hidden');
                btnText.innerText = "CONFIRM DEAL NOW";
                mainBtn.className = "w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-5 rounded-[1.5rem] text-lg shadow-xl shadow-blue-200 active:scale-[0.98] transition-all flex items-center justify-center gap-3";
                handleBankChange();
                startCountdown(invoiceSettings.deadlineMinutes || 30);
            } else if(method === 'Cash') {
                sectionTransfer.classList.add('hidden');
                sectionCash.classList.remove('hidden');
                btnText.innerText = "SCHEDULE THIS MEETING";
                mainBtn.className = "w-full bg-amber-600 hover:bg-amber-700 text-white font-black py-5 rounded-[1.5rem] text-lg shadow-xl shadow-amber-200 active:scale-[0.98] transition-all flex items-center justify-center gap-3";
                clearCountdown();
            }
        }

        function handleBankChange() {
            const bankSelect = document.getElementById('bankOption');
            const infoEl = document.getElementById('displayBankInfo');
            const holderEl = document.getElementById('displayAccountHolder');
            const copyBtn = document.getElementById('copyRekeningBtn');

            if (!bankSelect || !infoEl || !holderEl || !copyBtn) return;

            const key = bankSelect.value;
            const cfg = bankConfig[key];
            if (!cfg) return;

            infoEl.innerText = `${key} - ${cfg.number}`;
            holderEl.innerText = cfg.holder;
            copyBtn.dataset.account = cfg.number;
        }

        function copyRekening() {
            const btn = document.getElementById('copyRekeningBtn');
            if (!btn) return;
            const number = btn.dataset.account || '';
            if (!number) return;

            const onSuccess = () => {
                const original = btn.innerText;
                btn.innerText = "Copied";
                setTimeout(() => { btn.innerText = original; }, 1500);
            };

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(number).then(onSuccess).catch(() => {
                    alert("Gagal menyalin nomor rekening.");
                });
            } else {
                const temp = document.createElement('input');
                temp.value = number;
                document.body.appendChild(temp);
                temp.select();
                try { document.execCommand('copy'); } catch (e) {}
                document.body.removeChild(temp);
                onSuccess();
            }
        }

        function checkReferral() {
            const input = document.getElementById('referralCode');
            const msgEl = document.getElementById('referralMessage');
            if (!input || !msgEl) return;

            const code = input.value.trim().toUpperCase();
            msgEl.classList.remove('hidden');

            if (!code) {
                msgEl.textContent = "Masukkan kode referral jika ada.";
                msgEl.classList.remove('text-green-600');
                msgEl.classList.add('text-slate-500');
                return;
            }

            const found = referralConfig.find(function (r) { return r.code === code; });
            if (!found) {
                msgEl.textContent = "Kode referral tidak terdaftar.";
                msgEl.classList.remove('text-green-600');
                msgEl.classList.add('text-red-600');
                return;
            }

            const max = found.maxUsage || 0;
            const used = found.usedCount || 0;
            const remaining = Math.max(max - used, 0);

            msgEl.textContent = "Kode valid. Sisa " + remaining + " dari " + max + " kali pemakaian.";
            msgEl.classList.remove('text-red-600', 'text-slate-500');
            msgEl.classList.add('text-green-600');
        }

        function startCountdown(minutes) {
            const timerEl = document.getElementById('countdownTimer');
            if (!timerEl) return;

            countdownSeconds = minutes * 60;
            clearCountdown();

            const updateCountdownDisplay = () => {
                if (!timerEl) return;
                const m = String(Math.floor(countdownSeconds / 60)).padStart(2, '0');
                const s = String(countdownSeconds % 60).padStart(2, '0');
                timerEl.textContent = `${m}:${s}`;
            };

            updateCountdownDisplay();

            countdownInterval = setInterval(() => {
                countdownSeconds--;
                if (countdownSeconds <= 0) {
                    clearCountdown();
                    timerEl.textContent = "00:00";
                    return;
                }
                updateCountdownDisplay();
            }, 1000);
        }

        function clearCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        // Logic 3: File Upload Feedback
        function handleFileUpload() {
            const fileInput = document.getElementById('fileUpload');
            const successMsg = document.getElementById('uploadSuccess');
            
            if(fileInput.files.length > 0) {
                successMsg.classList.remove('hidden');
                lucide.createIcons(); // Re-render icons for the dynamic element
            }
        }

        // Logic 4: Submission
        function submitDeal() {
            const method = document.getElementById('paymentMethod').value;
            const amount = parseFormattedNumber(document.getElementById('amountPaid').value);
            
            // Validate DP Minimum
            if(document.getElementById('paymentType').value === 'dp' && amount < minDP) {
                alert("Maaf, minimal pembayaran DP adalah 35% (Rp " + minDP.toLocaleString('id-ID') + ")");
                return;
            }

            if(method === 'Cash') {
                // Redirect to WhatsApp
                const waUrl = `https://wa.me/628123456789?text=Halo%20Admin%20Dialogika,%20saya%20ingin%20janjian%20pembayaran%20CASH%20untuk%20kelas%20${encodeURIComponent(document.getElementById('className').innerText)}`;
                window.open(waUrl, '_blank');
            } else {
                // Confirm Logic for Transfer
                if(document.getElementById('fileUpload').files.length === 0) {
                    alert("Mohon upload bukti transfer Anda terlebih dahulu.");
                    return;
                }
                alert("Terima kasih! Pembayaran Anda sedang diproses oleh tim admin.");
            }
        }

        // Initial setup
        const invoiceEl = document.getElementById('invoiceNumber');
        if (invoiceEl) {
            invoiceEl.textContent = generateInvoiceNumber();
        }

        const leadEl = document.getElementById('leadName');
        const classEl = document.getElementById('className');
        const metaEl = document.getElementById('classMeta');
        const seatEl = document.getElementById('seatLeftLabel');
        const countdownEl = document.getElementById('countdownTimer');
        const displayBasePriceEl = document.getElementById('displayBasePrice');
        const priceInputEl = document.getElementById('inputPrice');
        const minWarningEl = document.getElementById('minWarning');

        if (leadEl) leadEl.textContent = invoiceSettings.leadName || leadEl.textContent;
        if (classEl) classEl.textContent = invoiceSettings.className || classEl.textContent;
        if (metaEl) metaEl.textContent = invoiceSettings.classMeta || metaEl.textContent;
        if (seatEl && typeof invoiceSettings.seatsLeft === "number") {
            seatEl.textContent = "Sisa Seat : " + invoiceSettings.seatsLeft;
        }
        if (displayBasePriceEl) {
            displayBasePriceEl.textContent = "Rp " + basePrice.toLocaleString("id-ID");
        }
        if (priceInputEl) {
            priceInputEl.value = basePrice.toLocaleString("id-ID");
        }
        if (minWarningEl) {
            minWarningEl.textContent = "* Minimal DP " + dpPercent + "% (Rp " + minDP.toLocaleString("id-ID") + ")";
        }
        if (countdownEl && invoiceSettings.deadlineMinutes) {
            countdownEl.textContent = String(invoiceSettings.deadlineMinutes).padStart(2, "0") + ":00";
        }

        handlePaymentTypeChange();
        handleBankChange();
        handleMethodChange();
    </script>
</body>
</html>
