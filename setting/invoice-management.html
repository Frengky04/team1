<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Management | Dialogika</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .tag { font-size: 10px; letter-spacing: 0.12em; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <main class="max-w-5xl mx-auto px-6 py-8 space-y-8">
        <header class="flex items-center justify-between mb-4">
            <div>
                <p class="tag font-bold uppercase text-blue-500 mb-1">Settings</p>
                <h1 class="text-2xl font-extrabold tracking-tight">Invoice Management</h1>
                <p class="text-sm text-slate-500 mt-1">Atur konten yang tampil di halaman invoice konfirmasi pembayaran.</p>
            </div>
            <div class="flex items-center gap-3">
                <a href="../example/inv.html" target="_blank" class="px-4 py-2 rounded-xl border border-slate-200 text-sm font-bold text-slate-700 bg-white hover:bg-slate-50">
                    Lihat Preview Invoice
                </a>
            </div>
        </header>

        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="tag text-slate-400 font-black uppercase">Konten Header</p>
                        <h2 class="font-bold text-lg text-slate-900 mt-1">Identitas Invoice</h2>
                    </div>
                </div>

                <div class="space-y-3 mt-2">
                    <div>
                        <label class="block text-[11px] font-black text-slate-500 uppercase mb-1 tracking-widest">Nama Penerima Invoice</label>
                        <input id="settingLeadName" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="Contoh: Andi Pratama">
                    </div>
                    <div>
                        <label class="block text-[11px] font-black text-slate-500 uppercase mb-1 tracking-widest">Program Kelas</label>
                        <input id="settingClassName" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="Contoh: Public Speaking Playbook">
                    </div>
                    <div>
                        <label class="block text-[11px] font-black text-slate-500 uppercase mb-1 tracking-widest">Lokasi, Batch</label>
                        <input id="settingClassMeta" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="Contoh: Batch 42 • Offline • Jakarta">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[11px] font-black text-slate-500 uppercase mb-1 tracking-widest">Sisa Seat</label>
                            <input id="settingSeatsLeft" type="number" min="0" class="w-full px-3 py-2 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="4">
                        </div>
                        <div>
                            <label class="block text-[11px] font-black text-slate-500 uppercase mb-1 tracking-widest">Batas Waktu (menit)</label>
                            <input id="settingDeadlineMinutes" type="number" min="1" class="w-full px-3 py-2 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="30">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[11px] font-black text-slate-500 uppercase mb-1 tracking-widest">Harga Kelas (Rp)</label>
                            <input id="settingBasePrice" type="number" min="0" class="w-full px-3 py-2 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="2500000">
                        </div>
                        <div>
                            <label class="block text-[11px] font-black text-slate-500 uppercase mb-1 tracking-widest">Minimal DP (%)</label>
                            <input id="settingDpPercent" type="number" min="0" max="100" class="w-full px-3 py-2 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="35">
                        </div>
                    </div>
                </div>

                <div class="pt-3">
                    <button id="btnSaveSettings" class="w-full inline-flex items-center justify-center gap-2 px-4 py-3 rounded-2xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-black tracking-wide shadow-md shadow-blue-200">
                        Simpan Pengaturan Invoice
                    </button>
                    <p id="statusSettings" class="mt-2 text-xs text-slate-400"></p>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="tag text-slate-400 font-black uppercase">Kode Referral</p>
                        <h2 class="font-bold text-lg text-slate-900 mt-1">Manajemen Referral</h2>
                    </div>
                </div>

                <div class="space-y-3">
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-[11px] font-black text-slate-500 uppercase mb-1 tracking-widest">Kode</label>
                            <input id="refCode" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="Contoh: DLGFRIEND">
                        </div>
                        <div>
                            <label class="block text-[11px] font-black text-slate-500 uppercase mb-1 tracking-widest">Maks Pemakaian</label>
                            <input id="refMaxUsage" type="number" min="1" class="w-full px-3 py-2 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="10">
                        </div>
                        <div>
                            <label class="block text-[11px] font-black text-slate-500 uppercase mb-1 tracking-widest">Sudah Dipakai</label>
                            <input id="refUsedCount" type="number" min="0" class="w-full px-3 py-2 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="0">
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <button id="btnSaveReferral" class="inline-flex items-center justify-center px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-black uppercase tracking-widest">
                            Simpan / Update Referral
                        </button>
                        <button id="btnClearReferralForm" class="text-xs font-bold text-slate-400 hover:text-slate-600">
                            Reset Form
                        </button>
                    </div>
                </div>

                <div class="mt-4 border-t border-slate-100 pt-3">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-[11px] font-black text-slate-400 uppercase tracking-widest">Daftar Referral</p>
                    </div>
                    <div class="max-h-64 overflow-auto border border-slate-100 rounded-xl">
                        <table class="min-w-full text-xs">
                            <thead class="bg-slate-50 text-slate-500">
                                <tr>
                                    <th class="px-3 py-2 text-left font-bold uppercase tracking-widest">Kode</th>
                                    <th class="px-3 py-2 text-center font-bold uppercase tracking-widest">Maks</th>
                                    <th class="px-3 py-2 text-center font-bold uppercase tracking-widest">Dipakai</th>
                                    <th class="px-3 py-2 text-center font-bold uppercase tracking-widest">Sisa</th>
                                    <th class="px-3 py-2 text-center font-bold uppercase tracking-widest">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="refTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 space-y-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="tag text-slate-400 font-black uppercase">Rekening Tujuan</p>
                    <h2 class="font-bold text-lg text-slate-900 mt-1">Daftar Bank Transfer</h2>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-2">
                <div>
                    <label class="block text-[11px] font-black text-slate-500 uppercase mb-1 tracking-widest">Nama Bank</label>
                    <input id="bankName" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="BCA / BRI / BSI">
                </div>
                <div>
                    <label class="block text-[11px] font-black text-slate-500 uppercase mb-1 tracking-widest">No. Rekening</label>
                    <input id="bankNumber" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="8920129301">
                </div>
                <div>
                    <label class="block text-[11px] font-black text-slate-500 uppercase mb-1 tracking-widest">Atas Nama</label>
                    <input id="bankHolder" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="PT Dialogika Indonesia">
                </div>
            </div>
            <input id="bankId" type="hidden">
            <div class="flex justify-between items-center mt-3">
                <button id="btnSaveBank" class="inline-flex items-center justify-center px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-xs font-black uppercase tracking-widest">
                    Simpan / Update Rekening
                </button>
                <button id="btnClearBankForm" class="text-xs font-bold text-slate-400 hover:text-slate-600">
                    Reset Form Rekening
                </button>
            </div>

            <div class="mt-4 border-t border-slate-100 pt-3">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-[11px] font-black text-slate-400 uppercase tracking-widest">Daftar Rekening</p>
                </div>
                <div class="max-h-64 overflow-auto border border-slate-100 rounded-xl">
                    <table class="min-w-full text-xs">
                        <thead class="bg-slate-50 text-slate-500">
                            <tr>
                                <th class="px-3 py-2 text-left font-bold uppercase tracking-widest">Bank</th>
                                <th class="px-3 py-2 text-left font-bold uppercase tracking-widest">No. Rekening</th>
                                <th class="px-3 py-2 text-left font-bold uppercase tracking-widest">Atas Nama</th>
                                <th class="px-3 py-2 text-center font-bold uppercase tracking-widest">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="bankTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <script>
        const STORAGE_KEY_SETTINGS = "dlg_invoice_settings";
        const STORAGE_KEY_BANKS = "dlg_invoice_banks";
        const STORAGE_KEY_REFERRALS = "dlg_invoice_referrals";

        function loadSettings() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY_SETTINGS);
                if (!raw) {
                    return {
                        leadName: "Andi Pratama",
                        className: "Public Speaking Playbook",
                        classMeta: "Batch 42 • Offline • Jakarta",
                        seatsLeft: 4,
                        deadlineMinutes: 30,
                        basePrice: 2500000,
                        dpPercent: 35
                    };
                }
                const parsed = JSON.parse(raw);
                return Object.assign({
                    leadName: "",
                    className: "",
                    classMeta: "",
                    seatsLeft: 0,
                    deadlineMinutes: 30,
                    basePrice: 0,
                    dpPercent: 35
                }, parsed);
            } catch (e) {
                return {
                    leadName: "",
                    className: "",
                    classMeta: "",
                    seatsLeft: 0,
                    deadlineMinutes: 30,
                    basePrice: 0,
                    dpPercent: 35
                };
            }
        }

        function saveSettings(settings) {
            localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings));
        }

        function loadBanks() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY_BANKS);
                if (!raw) {
                    return [
                        { id: "BCA", name: "BCA", number: "8920129301", holder: "PT Dialogika Indonesia" },
                        { id: "BCA_SYR", name: "BCA Syariah", number: "8920129301", holder: "PT Dialogika Indonesia" },
                        { id: "BSI", name: "BSI", number: "8920129301", holder: "PT Dialogika Indonesia" }
                    ];
                }
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                return [];
            }
        }

        function saveBanks(banks) {
            localStorage.setItem(STORAGE_KEY_BANKS, JSON.stringify(banks));
        }

        function loadReferrals() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY_REFERRALS);
                const parsed = raw ? JSON.parse(raw) : [];
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                return [];
            }
        }

        function saveReferrals(referrals) {
            localStorage.setItem(STORAGE_KEY_REFERRALS, JSON.stringify(referrals));
        }

        let currentBanks = [];
        let currentReferrals = [];

        function renderSettings() {
            const s = loadSettings();
            document.getElementById("settingLeadName").value = s.leadName || "";
            document.getElementById("settingClassName").value = s.className || "";
            document.getElementById("settingClassMeta").value = s.classMeta || "";
            document.getElementById("settingSeatsLeft").value = s.seatsLeft || "";
            document.getElementById("settingDeadlineMinutes").value = s.deadlineMinutes || "";
            document.getElementById("settingBasePrice").value = s.basePrice || "";
            document.getElementById("settingDpPercent").value = s.dpPercent || "";
        }

        function renderBanks() {
            const tbody = document.getElementById("bankTableBody");
            tbody.innerHTML = "";
            currentBanks.forEach(function (b) {
                const tr = document.createElement("tr");
                tr.innerHTML = [
                    '<td class="px-3 py-2 font-semibold text-slate-800">' + b.name + "</td>",
                    '<td class="px-3 py-2 text-slate-700">' + b.number + "</td>",
                    '<td class="px-3 py-2 text-slate-500">' + b.holder + "</td>",
                    '<td class="px-3 py-2 text-center space-x-2">' +
                        '<button data-id="' + b.id + '" class="edit-bank text-[10px] font-bold text-blue-600 hover:text-blue-800">Edit</button>' +
                        '<button data-id="' + b.id + '" class="delete-bank text-[10px] font-bold text-rose-600 hover:text-rose-800">Delete</button>' +
                    "</td>"
                ].join("");
                tbody.appendChild(tr);
            });
        }

        function renderReferrals() {
            const tbody = document.getElementById("refTableBody");
            tbody.innerHTML = "";
            currentReferrals.forEach(function (r, idx) {
                const max = r.maxUsage || 0;
                const used = r.usedCount || 0;
                const remaining = Math.max(max - used, 0);
                const tr = document.createElement("tr");
                tr.innerHTML = [
                    '<td class="px-3 py-2 font-semibold text-slate-800">' + r.code + "</td>",
                    '<td class="px-3 py-2 text-center text-slate-700">' + max + "</td>",
                    '<td class="px-3 py-2 text-center text-slate-700">' + used + "</td>",
                    '<td class="px-3 py-2 text-center ' + (remaining > 0 ? "text-emerald-600" : "text-slate-400") + '">' + remaining + "</td>",
                    '<td class="px-3 py-2 text-center space-x-2">' +
                        '<button data-idx="' + idx + '" class="edit-ref text-[10px] font-bold text-blue-600 hover:text-blue-800">Edit</button>' +
                        '<button data-idx="' + idx + '" class="delete-ref text-[10px] font-bold text-rose-600 hover:text-rose-800">Delete</button>' +
                    "</td>"
                ].join("");
                tbody.appendChild(tr);
            });
        }

        function attachEvents() {
            document.getElementById("btnSaveSettings").addEventListener("click", function () {
                const status = document.getElementById("statusSettings");
                const data = {
                    leadName: document.getElementById("settingLeadName").value.trim(),
                    className: document.getElementById("settingClassName").value.trim(),
                    classMeta: document.getElementById("settingClassMeta").value.trim(),
                    seatsLeft: parseInt(document.getElementById("settingSeatsLeft").value, 10) || 0,
                    deadlineMinutes: parseInt(document.getElementById("settingDeadlineMinutes").value, 10) || 30,
                    basePrice: parseInt(document.getElementById("settingBasePrice").value, 10) || 0,
                    dpPercent: parseInt(document.getElementById("settingDpPercent").value, 10) || 35
                };
                saveSettings(data);
                status.textContent = "Tersimpan. Buka ulang halaman invoice untuk melihat perubahan.";
                setTimeout(function () {
                    status.textContent = "";
                }, 2500);
            });

            document.getElementById("btnSaveBank").addEventListener("click", function () {
                const idField = document.getElementById("bankId");
                const nameField = document.getElementById("bankName");
                const numberField = document.getElementById("bankNumber");
                const holderField = document.getElementById("bankHolder");

                const name = nameField.value.trim();
                const number = numberField.value.trim();
                const holder = holderField.value.trim();

                if (!name || !number) {
                    alert("Nama bank dan nomor rekening wajib diisi.");
                    return;
                }

                let id = idField.value;
                if (!id) {
                    id = "BANK_" + Date.now();
                }

                const existingIndex = currentBanks.findIndex(function (b) { return b.id === id; });
                const item = { id: id, name: name, number: number, holder: holder };

                if (existingIndex >= 0) {
                    currentBanks[existingIndex] = item;
                } else {
                    currentBanks.push(item);
                }

                saveBanks(currentBanks);
                renderBanks();

                idField.value = "";
                nameField.value = "";
                numberField.value = "";
                holderField.value = "";
            });

            document.getElementById("btnClearBankForm").addEventListener("click", function () {
                document.getElementById("bankId").value = "";
                document.getElementById("bankName").value = "";
                document.getElementById("bankNumber").value = "";
                document.getElementById("bankHolder").value = "";
            });

            document.getElementById("bankTableBody").addEventListener("click", function (e) {
                const target = e.target;
                if (target.classList.contains("edit-bank")) {
                    const id = target.getAttribute("data-id");
                    const bank = currentBanks.find(function (b) { return b.id === id; });
                    if (!bank) return;
                    document.getElementById("bankId").value = bank.id;
                    document.getElementById("bankName").value = bank.name;
                    document.getElementById("bankNumber").value = bank.number;
                    document.getElementById("bankHolder").value = bank.holder;
                }
                if (target.classList.contains("delete-bank")) {
                    const id = target.getAttribute("data-id");
                    if (!confirm("Hapus rekening ini?")) return;
                    currentBanks = currentBanks.filter(function (b) { return b.id !== id; });
                    saveBanks(currentBanks);
                    renderBanks();
                }
            });

            document.getElementById("btnSaveReferral").addEventListener("click", function () {
                const codeField = document.getElementById("refCode");
                const maxField = document.getElementById("refMaxUsage");
                const usedField = document.getElementById("refUsedCount");

                const code = codeField.value.trim().toUpperCase();
                const maxUsage = parseInt(maxField.value, 10) || 0;
                const usedCount = parseInt(usedField.value, 10) || 0;

                if (!code || maxUsage <= 0) {
                    alert("Kode dan maksimal pemakaian wajib diisi.");
                    return;
                }

                const existingIndex = currentReferrals.findIndex(function (r) { return r.code === code; });
                const item = { code: code, maxUsage: maxUsage, usedCount: usedCount };

                if (existingIndex >= 0) {
                    currentReferrals[existingIndex] = item;
                } else {
                    currentReferrals.push(item);
                }

                saveReferrals(currentReferrals);
                renderReferrals();

                codeField.value = "";
                maxField.value = "";
                usedField.value = "";
            });

            document.getElementById("btnClearReferralForm").addEventListener("click", function () {
                document.getElementById("refCode").value = "";
                document.getElementById("refMaxUsage").value = "";
                document.getElementById("refUsedCount").value = "";
            });

            document.getElementById("refTableBody").addEventListener("click", function (e) {
                const target = e.target;
                if (target.classList.contains("edit-ref")) {
                    const idx = parseInt(target.getAttribute("data-idx"), 10);
                    const item = currentReferrals[idx];
                    if (!item) return;
                    document.getElementById("refCode").value = item.code;
                    document.getElementById("refMaxUsage").value = item.maxUsage;
                    document.getElementById("refUsedCount").value = item.usedCount;
                }
                if (target.classList.contains("delete-ref")) {
                    const idx = parseInt(target.getAttribute("data-idx"), 10);
                    if (isNaN(idx)) return;
                    if (!confirm("Hapus kode referral ini?")) return;
                    currentReferrals.splice(idx, 1);
                    saveReferrals(currentReferrals);
                    renderReferrals();
                }
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            renderSettings();
            currentBanks = loadBanks();
            currentReferrals = loadReferrals();
            renderBanks();
            renderReferrals();
            attachEvents();
        });
    </script>
</body>
</html>
